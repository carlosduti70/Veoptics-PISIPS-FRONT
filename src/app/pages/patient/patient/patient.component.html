<p-toast></p-toast>

<p-fluid>
    <div class="card">
        <h3 class="colorSecondaryText font-bold text-2xl mb-4">Gestión de Pacientes</h3>

        <p-toolbar styleClass="mb-4 gap-2 border-none bg-transparent p-0">
            <ng-template pTemplate="left">
                <p-button label="Nuevo Paciente" icon="pi pi-plus" severity="primary" class="mr-2"
                    (onClick)="openNew()" />
            </ng-template>

            <!-- <ng-template pTemplate="right">
                <div class="flex gap-2">
                    <p-button icon="pi pi-file-excel" label="Exportar Excel" severity="success"
                        (onClick)="exportExcel()" />
                </div>
            </ng-template> -->
        </p-toolbar>

        <p-table #dt [value]="pacientes" [rows]="10" [paginator]="true"
            [globalFilterFields]="['nombre','apellido','ci','correo']" [tableStyle]="{ 'min-width': '75rem' }"
            [rowHover]="true" dataKey="idPaciente"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} pacientes"
            [showCurrentPageReport]="true" [loading]="loading" styleClass="p-datatable-sm p-datatable-striped">

            <ng-template pTemplate="caption">
                <div class="flex flex-row justify-between items-center w-full mb-2">

                    <h5 class="m-0 colorSecondaryText font-semibold">
                        Listado de Pacientes
                    </h5>

                    <p-iconfield>
                        <p-inputicon styleClass="pi pi-search" />
                        <input pInputText type="text" (input)="dt.filterGlobal($any($event.target).value, 'contains')"
                            placeholder="Buscar..." class="p-inputtext-sm" />
                    </p-iconfield>

                </div>
            </ng-template>

            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="ci" class="colorSecondaryText">C.I. <p-sortIcon field="ci" /></th>
                    <th pSortableColumn="apellido" class="colorSecondaryText">Nombre Completo <p-sortIcon
                            field="apellido" /></th>
                    <th class="colorSecondaryText">Teléfono</th>
                    <th class="colorSecondaryText">Correo</th>
                    <th pSortableColumn="fecRegistro" class="colorSecondaryText">Fecha Registro <p-sortIcon
                            field="fecRegistro" /></th>
                    <th class="colorSecondaryText">Estado</th>
                    <th class="colorSecondaryText"></th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-paciente>
                <tr>
                    <td class="font-bold">{{ paciente.ci }}</td>
                    <td>{{ paciente.apellido }} {{ paciente.nombre }}</td>
                    <td>{{ paciente.telefono }}</td>
                    <td>{{ paciente.correo }}</td>
                    <td>{{ paciente.fecRegistro | date:'dd/MM/yyyy' }}</td>
                    <td>
                        <p-tag [value]="paciente.estado === 'A' ? 'ACTIVO' : 'INACTIVO'" [rounded]="true"
                            [severity]="paciente.estado === 'A' ? 'success' : 'danger'" />
                    </td>
                    <td class="text-center">
                        <p-button icon="pi pi-file-pdf" pTooltip="Descargar Último Certificado" tooltipPosition="top"
                            [rounded]="true" [text]="true" severity="danger" class="mr-2"
                            (onClick)="downloadCertificate(paciente)" />

                        <button pButton icon="pi pi-pencil" class="p-button-rounded p-button-text p-button-warning"
                            (click)="editPatient(paciente)">
                        </button>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</p-fluid>

<p-dialog [(visible)]="pacienteDialog" [style]="{ width: '800px' }" [modal]="true" styleClass="p-fluid"
    [draggable]="false" [resizable]="false" header=" ">

    <ng-template pTemplate="header">
        <div class="flex flex-col">
            <div class="font-bold text-xl colorSecondaryText">
                {{ esEdicion ? 'Actualizar' : 'Registrar nuevo' }} <span class="colorPrimaryText">Paciente</span>
            </div>
            <span class="text-sm text-gray-500">
                {{ esEdicion ? 'Modifique la información necesaria' : 'Complete la información del nuevo paciente' }}
            </span>
        </div>
    </ng-template>

    <ng-template pTemplate="content">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">

            <div class="flex flex-col gap-2">
                <label class="text-sm font-semibold colorSecondaryText">Cédula / DNI</label>

                <input type="text" pInputText [(ngModel)]="paciente.ci" name="ci" #ciInput="ngModel" required
                    maxlength="10" (input)="validarSoloNumeros($event)" placeholder="Ingrese 10 dígitos" />

                <small class="text-red-500 font-bold" *ngIf="submitted && !paciente.ci">
                    <i class="pi pi-exclamation-circle mr-1"></i>Requerido
                </small>

                <small class="text-red-500 font-bold" *ngIf="submitted && paciente.ci && paciente.ci.length !== 10">
                    <i class="pi pi-exclamation-circle mr-1"></i>La cédula debe tener exactamente 10 dígitos
                </small>

                <small class="text-orange-600 font-bold block mt-1" *ngIf="backendErrors.ci">
                    <i class="pi pi-info-circle mr-1"></i>{{ backendErrors.ci }}
                </small>
            </div>

            <div class="flex flex-col gap-2">
                <label class="text-sm font-semibold colorSecondaryText">Estado</label>
                <p-dropdown [(ngModel)]="paciente.estado" [options]="estados" optionLabel="label" optionValue="value"
                    placeholder="Seleccione Estado" styleClass="w-full"></p-dropdown>
            </div>

            <div class="flex flex-col gap-2">
                <label class="text-sm font-semibold colorSecondaryText">Nombres</label>
                <input type="text" pInputText [(ngModel)]="paciente.nombre" required placeholder="Ingrese nombres"
                    (input)="validarSoloLetras($event, 'nombre')" />
                <small class="text-red-500 font-bold" *ngIf="submitted && !paciente.nombre">
                    <i class="pi pi-exclamation-circle mr-1"></i>Requerido
                </small>
            </div>

            <div class="flex flex-col gap-2">
                <label class="text-sm font-semibold colorSecondaryText">Apellidos</label>
                <input type="text" pInputText [(ngModel)]="paciente.apellido" required placeholder="Ingrese apellidos"
                    (input)="validarSoloLetras($event, 'apellido')" />
                <small class="text-red-500 font-bold" *ngIf="submitted && !paciente.apellido">
                    <i class="pi pi-exclamation-circle mr-1"></i>Requerido
                </small>
            </div>

            <div class="flex flex-col gap-2">
                <label class="text-sm font-semibold colorSecondaryText">Correo Electrónico</label>
                <input type="email" pInputText [(ngModel)]="paciente.correo" name="correo" #correoInput="ngModel"
                    placeholder="ejemplo@email.com" required
                    pattern="^[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}$" />

                <small class="text-red-500 font-bold" *ngIf="submitted && !paciente.correo">
                    <i class="pi pi-exclamation-circle mr-1"></i>Requerido
                </small>

                <small class="text-red-500 font-bold" *ngIf="submitted && correoInput.errors?.['pattern']">
                    <i class="pi pi-exclamation-circle mr-1"></i>Ingrese un correo válido (ej: usuario&#64;dominio.com)
                </small>

                <small class="text-orange-600 font-bold block mt-1" *ngIf="backendErrors.correo">
                    <i class="pi pi-info-circle mr-1"></i>{{ backendErrors.correo }}
                </small>
            </div>

            <div class="flex flex-col gap-2">
                <label class="text-sm font-semibold colorSecondaryText">Teléfono</label>
                <input type="text" pInputText [(ngModel)]="paciente.telefono" placeholder="099..." required
                    maxlength="10" (input)="validarSoloNumerosTelefono($event)" />

                <small class="text-red-500 font-bold" *ngIf="submitted && !paciente.telefono">
                    <i class="pi pi-exclamation-circle mr-1"></i>Requerido
                </small>

                <small class="text-red-500 font-bold"
                    *ngIf="submitted && paciente.telefono && (paciente.telefono.length < 7 || paciente.telefono.length > 10)">
                    <i class="pi pi-exclamation-circle mr-1"></i>Debe tener entre 7 y 10 dígitos
                </small>

                <small class="text-orange-600 font-bold block mt-1" *ngIf="backendErrors.telefono">
                    <i class="pi pi-info-circle mr-1"></i>{{ backendErrors.telefono }}
                </small>
            </div>

            <div class="flex flex-col gap-2">
                <label class="text-sm font-semibold colorSecondaryText">Fecha Nacimiento</label>

                <p-datepicker [(ngModel)]="paciente.fecNacimiento" [iconDisplay]="'input'" [showIcon]="true"
                    inputId="fecNac" dateFormat="yy-mm-dd" appendTo="body" styleClass="w-full">
                </p-datepicker>

                <small class="text-red-500 font-bold" *ngIf="submitted && !paciente.fecNacimiento">
                    <i class="pi pi-exclamation-circle mr-1"></i>Requerido
                </small>

                <small class="text-orange-600 font-bold block mt-1" *ngIf="backendErrors.fecNacimiento">
                    <i class="pi pi-info-circle mr-1"></i>{{ backendErrors.fecNacimiento }}
                </small>
            </div>

            <div class="col-span-1 md:col-span-2 flex flex-col gap-2">
                <label class="text-sm font-semibold colorSecondaryText">Dirección Domiciliaria</label>
                <input type="text" pInputText [(ngModel)]="paciente.direccion"
                    placeholder="Ingrese dirección completa" />
                <small class="text-red-500 font-bold" *ngIf="submitted && !paciente.direccion">
                    <i class="pi pi-exclamation-circle mr-1"></i>Requerido
                </small>
            </div>

        </div>
    </ng-template>

    <ng-template pTemplate="footer">
        <div class="flex justify-end gap-3 mt-4 pt-4 border-t border-gray-200">
            <p-button label="Cancelar" icon="pi pi-times" [text]="true" severity="secondary" (onClick)="hideDialog()" />

            <p-button [label]="esEdicion ? 'Actualizar Paciente' : 'Guardar Paciente'" icon="pi pi-check"
                severity="primary" (onClick)="savePatient()" [loading]="loading" />
        </div>
    </ng-template>
</p-dialog>
